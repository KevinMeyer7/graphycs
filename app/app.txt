**********
CONTEXT BEGIN
**********
-----------
1. Filename api/trpc/[trpc]/route.ts content:
import { fetchRequestHandler } from '@trpc/server/adapters/fetch';
import { appRouter } from '@/server/api/root';
import { type NextRequest } from 'next/server';

const handler = (req: NextRequest) =>
  fetchRequestHandler({
    endpoint: '/api/trpc',
    req,
    router: appRouter,
    createContext: () => ({}),
  });

export { handler as GET, handler as POST };
-----------
-----------
2. Filename globals.css content:
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;
    --primary: 222.2 47.4% 11.2%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.2 84% 4.9%;
    --radius: 0.5rem;
  }
}

@layer base {
  * {
    border-color: hsl(var(--border));
  }
  body {
    background-color: hsl(var(--background));
    color: hsl(var(--foreground));
  }
}
-----------
-----------
3. Filename layout.tsx content:
import type { Metadata } from "next";
import "./globals.css";

export const metadata: Metadata = {
  title: "GraphycsOS - Compliance Course Factory",
  description: "Create engaging compliance training courses automatically",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  );
}
-----------
-----------
4. Filename page.tsx content:
"use client";

import React, { useEffect, useMemo, useRef, useState } from "react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { httpBatchLink } from "@trpc/client";
import superjson from "superjson";
import { createTRPCReact } from "@trpc/react-query";
import { z } from "zod";

// UI (shadcn)
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectTrigger, SelectContent, SelectValue, SelectItem } from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { Badge } from "@/components/ui/badge";

// Icons
import { Play, Wand2, AudioLines, Film, Loader2, CheckCircle2 } from "lucide-react";

// Remotion + Lottie preview
import { Player } from "@remotion/player";
import { AbsoluteFill, Sequence } from "remotion";
import Lottie from "lottie-react";

/**
 * STEP 1.1 — shadcn UI + tRPC + Remotion Player + Lottie + OpenAI Responses API (GPT‑5)
 * -------------------------------------------------------------------------------------
 * What changed:
 *  - Uses **GPT‑5** (or OPENAI_MODEL env override) via Responses API + JSON schema
 *  - Adds a visual **progress bar + stepper** while generating
 *  - Keeps fallback path if API fails (demo never stalls)
 *
 * ENV:
 *  - OPENAI_API_KEY (required)
 *  - OPENAI_MODEL (optional, default 'gpt-4o' — will use gpt-5 when available)
 */

// ---------- Types shared client/server ----------
export type Module = { title: string; points: string[]; lottie: "office" | "checklist" | "security" };
export type Storyboard = {
  title: string;
  language: string;
  intro: string;
  overview: string[];
  modules: Module[];
  summary: string;
  quiz: { q: string; a: string[]; correct: number }[];
};

// ---------- Minimal inline Lotties (replace with curated comic pack) ----------
const LOADING_BUBBLES = {
  v: "5.7.8", fr: 30, ip: 0, op: 120, w: 200, h: 120, nm: "bubbles", ddd: 0, assets: [],
  layers: Array.from({ length: 4 }).map((_, i) => ({
    ddd: 0, ind: i + 1, ty: 4, sr: 1,
    ks: { o: { a: 0, k: 100 }, r: { a: 0, k: 0 }, p: { a: 0, k: [40 + i * 40, 60, 0] }, a: { a: 0, k: [0, 0, 0] }, s: { a: 0, k: [100, 100, 100] } },
    shapes: [ { ty: "el", p: { a: 0, k: [0, 0] }, s: { a: 0, k: [16, 16] }, d: 1 }, { ty: "fl", c: { a: 0, k: [0.1, 0.6, 0.95, 1] }, o: { a: 0, k: 100 }, r: 1 } ],
    ip: 0, op: 120, st: 0, bm: 0,
  }))
};
const lottieMap: Record<Module["lottie"], any> = {
  office: LOADING_BUBBLES,
  checklist: LOADING_BUBBLES,
  security: LOADING_BUBBLES,
};

// ---------- Remotion composition ----------
export const VideoComposition: React.FC<{ storyboard: Storyboard }> = ({ storyboard }) => {
  const fps = 30;
  const perScene = 4 * fps; // 4s/module for demo
  return (
    <AbsoluteFill style={{ background: "#fff" }}>
      {storyboard.modules.map((m, i) => (
        <Sequence key={i} from={i * perScene} durationInFrames={perScene}>
          <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr", height: "100%" }}>
            <div style={{ padding: 48 }}>
              <h1 style={{ fontSize: 48, marginBottom: 12 }}>{m.title}</h1>
              <ul style={{ fontSize: 28, lineHeight: 1.4 }}>
                {m.points.map((p, j) => <li key={j}>{p}</li>)}
              </ul>
            </div>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "center" }}>
              <div style={{ width: 240, height: 160 }}>
                <Lottie animationData={lottieMap[m.lottie]} loop autoplay />
              </div>
            </div>
          </div>
        </Sequence>
      ))}
    </AbsoluteFill>
  );
};

// ---------- tRPC client ----------
export const trpc = createTRPCReact<import("@/trpc-types").AppRouter>();
const queryClient = new QueryClient();
function TRPCProvider({ children }: { children: React.ReactNode }) {
  return (
    <trpc.Provider client={trpc.createClient({
      links: [httpBatchLink({ url: "/api/trpc", transformer: superjson })],
      transformer: superjson,
    })} queryClient={queryClient}>
      <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
    </trpc.Provider>
  );
}

// ---------- UI ----------
const SAMPLE_TEXT = `Die DSGVO schützt personenbezogene Daten. Mitarbeitende müssen verstehen: Welche Daten erfassen wir? Rechtsgrundlage? Einwilligung? Vorfallsmeldung? Fehler vermeiden durch Minimierung, Prozesse, Schulungen.`;

function Stepper({ step }: { step: number }) {
  const steps = ["Sende an GPT", "Erhalte JSON", "Szene-Komposition", "Bereit"];
  const pct = [10, 45, 80, 100][Math.min(step, 3)];
  return (
    <div className="space-y-2">
      <div className="flex items-center gap-2 text-sm">
        {steps.map((s, i) => (
          <div key={i} className={`flex items-center gap-1 ${i <= step ? 'text-emerald-600' : 'text-gray-400'}`}>
            {i < step ? <CheckCircle2 className="w-4 h-4"/> : <Loader2 className="w-4 h-4 animate-spin"/>}
            <span>{s}</span>
            {i < steps.length - 1 && <span className="mx-2 text-gray-300">›</span>}
          </div>
        ))}
      </div>
      <Progress value={pct} className="h-2" />
    </div>
  );
}

function DemoPage() {
  const [text, setText] = useState(SAMPLE_TEXT);
  const [style, setStyle] = useState<Module["lottie"]>("office");
  const generate = trpc.structure.generate.useMutation();

  // Local progress stepper while the mutation is inflight
  const [step, setStep] = useState(0);
  useEffect(() => {
    if (generate.isLoading) {
      setStep(0);
      const a = setTimeout(() => setStep(1), 300);
      const b = setTimeout(() => setStep(2), 900);
      const c = setTimeout(() => setStep(3), 1600);
      return () => { clearTimeout(a); clearTimeout(b); clearTimeout(c); };
    }
  }, [generate.isLoading]);

  const story = generate.data as Storyboard | undefined;
  const durationInFrames = (story?.modules?.length || 3) * 4 * 30;

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100">
      <header className="max-w-5xl mx-auto px-6 py-8 flex items-center justify-between">
        <h1 className="text-2xl md:text-3xl font-bold tracking-tight">Graphycs v2 · shadcn + tRPC + Remotion</h1>
        <div className="flex gap-2">
          <Button onClick={() => generate.mutate({ text, defaultStyle: style })} className="gap-2" disabled={generate.isLoading}>
            {generate.isLoading ? <Loader2 className="w-4 h-4 animate-spin"/> : <Wand2 className="w-4 h-4"/>}
            {generate.isLoading ? "Generating…" : "Generate"}
          </Button>
          <Button variant="outline" className="gap-2" onClick={()=>document.getElementById("preview")?.scrollIntoView({behavior:"smooth"})}>
            <Play className="w-4 h-4"/>Preview
          </Button>
        </div>
      </header>

      <main className="max-w-5xl mx-auto px-6 pb-24 space-y-8">
        <Card className="p-6 rounded-2xl shadow-sm space-y-3">
          <Label>1) Paste policy text</Label>
          <Textarea value={text} onChange={(e)=>setText(e.target.value)} rows={5} className="font-mono"/>
          <div className="flex items-center gap-3 pt-2">
            <Label className="text-sm">Comic Pack</Label>
            <Select value={style} onValueChange={(v)=>setStyle(v as Module["lottie"]) }>
              <SelectTrigger className="w-56"><SelectValue placeholder="Choose style"/></SelectTrigger>
              <SelectContent>
                <SelectItem value="office">Office</SelectItem>
                <SelectItem value="checklist">Checklist</SelectItem>
                <SelectItem value="security">Security</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </Card>

        <Card className="p-6 rounded-2xl shadow-sm">
          <h2 className="text-xl font-semibold mb-3">2) Script</h2>
          {generate.isIdle && !story && <p className="text-sm text-gray-500">Click Generate to structure the storyboard via OpenAI (JSON schema enforced).</p>}
          {generate.isLoading && <Stepper step={step} />}
          {story && (
            <div className="space-y-3 text-sm">
              <div><span className="font-semibold">Intro:</span> {story.intro}</div>
              <div>
                <span className="font-semibold">Overview:</span>
                <ul className="list-disc ml-5">{story.overview.map((o,i)=>(<li key={i}>{o}</li>))}</ul>
              </div>
              <div>
                <span className="font-semibold">Modules:</span>
                <ol className="list-decimal ml-5 space-y-2">
                  {story.modules.map((m,i)=> (
                    <li key={i}><span className="font-medium">{m.title}</span> — style <code>{m.lottie}</code>
                      <ul className="list-disc ml-5">{m.points.map((p,j)=>(<li key={j}>{p}</li>))}</ul>
                    </li>
                  ))}
                </ol>
              </div>
              <div><span className="font-semibold">Summary:</span> {story.summary}</div>
            </div>
          )}
        </Card>

        <Card id="preview" className="p-6 rounded-2xl shadow-sm space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-semibold">3) Preview (Remotion + Lottie)</h2>
            <div className="flex gap-2">
              <Button variant="outline" className="gap-2" onClick={()=>alert("TTS next: ElevenLabs → <Audio/> in Composition.")}> <AudioLines className="w-4 h-4"/>Add Voice (next)</Button>
              <Button variant="outline" className="gap-2" onClick={()=>alert("Server render next: @remotion/renderer → MP4.")}> <Film className="w-4 h-4"/>Render MP4 (next)</Button>
            </div>
          </div>
          {story ? (
            <Player
              component={VideoComposition}
              inputProps={{ storyboard: story }}
              durationInFrames={durationInFrames}
              compositionWidth={1280}
              compositionHeight={720}
              fps={30}
              controls
              style={{ borderRadius: 16, overflow: "hidden", boxShadow: "0 8px 30px rgba(0,0,0,0.08)" }}
            />
          ) : (
            <div className="text-sm text-gray-500">Generate a script to see the composition.</div>
          )}
        </Card>
      </main>
    </div>
  );
}

export default function App() {
  return (
    <TRPCProvider>
      <DemoPage />
    </TRPCProvider>
  );
}
-----------
**********
CONTEXT END
**********
